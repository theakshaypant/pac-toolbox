name: Daily E2E Failure Report

on:
  schedule:
    # Run every day at 3:00 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      since:
        description: 'Time period (e.g., 7d, 24h, 2w)'
        required: false
        default: '24h'

env:
  PAC_REPO: openshift-pipelines/pipelines-as-code

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch E2E Failures
        env:
          GH_TOKEN: ${{ secrets.PAC_TOKEN }}
        run: |
          chmod +x ./scripts/fetch-pac-e2e-failures.sh
          
          SINCE="${{ github.event.inputs.since || '24h' }}"
          
          # Run the script with full output to logs (include context for Gemini analysis)
          ./fetch-pac-e2e-failures.sh -s "$SINCE" --failed --context | tee /tmp/full-output.txt
          
          # Extract just the summary for GitHub step summary
          echo "## ðŸ“Š PAC E2E Failure Report" >> $GITHUB_STEP_SUMMARY
          echo "**Period:** Last $SINCE | **Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          awk '/SUMMARY: Failed Tests Frequency/{p=1} /FAILURE CONTEXT/{p=0} p' /tmp/full-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Extract failure context for Gemini (from FAILURE CONTEXT section to end)
          sed -n '/FAILURE CONTEXT/,$p' /tmp/full-output.txt > /tmp/failure-context.txt || true

      - name: Analyze with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Skip if no API key configured
          if [[ -z "$GEMINI_API_KEY" ]]; then
            echo "GEMINI_API_KEY not configured, skipping analysis"
            exit 0
          fi
          
          # Check if we have any failure context
          if [[ ! -s /tmp/failure-context.txt ]]; then
            echo "No failure context to analyze"
            exit 0
          fi
          
          # Read prompt from file and append failure context
          FAILURE_CONTEXT=$(cat /tmp/failure-context.txt | head -c 30000)
          PROMPT_BASE=$(cat ./prompts/e2e-failure-triage.txt)
          PROMPT="${PROMPT_BASE}
          
          ${FAILURE_CONTEXT}
          
          END FAILURE CONTEXT"

          # Call Gemini API
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg prompt "$PROMPT" '{contents: [{parts: [{text: $prompt}]}]}')")
          
          # Extract the text response
          ANALYSIS=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Failed to get analysis"')
          
          echo "## ðŸ¤– Gemini Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$ANALYSIS" >> $GITHUB_STEP_SUMMARY
          
          # Also print to logs
          echo "=== Gemini Analysis ==="
          echo "$ANALYSIS"