name: Daily E2E Failure Report

on:
  schedule:
    # Run every day at 3:00 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      since:
        description: 'Time period (e.g., 7d, 24h, 2w)'
        required: false
        default: '24h'

env:
  PAC_REPO: openshift-pipelines/pipelines-as-code

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch E2E Failures
        env:
          GH_TOKEN: ${{ secrets.PAC_TOKEN }}
        run: |
          chmod +x ./fetch-pac-e2e-failures.sh
          
          SINCE="${{ github.event.inputs.since || '24h' }}"
          
          # Run the script with full output to logs (include context for Gemini analysis)
          ./fetch-pac-e2e-failures.sh -s "$SINCE" --failed --context | tee /tmp/full-output.txt
          
          # Extract just the summary for GitHub step summary
          echo "## ðŸ“Š PAC E2E Failure Report" >> $GITHUB_STEP_SUMMARY
          echo "**Period:** Last $SINCE | **Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          awk '/SUMMARY: Failed Tests Frequency/{p=1} /FAILURE CONTEXT/{p=0} p' /tmp/full-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Extract failure context for Gemini (from FAILURE CONTEXT section to end)
          sed -n '/FAILURE CONTEXT/,$p' /tmp/full-output.txt > /tmp/failure-context.txt || true

      - name: Analyze with Gemini
        if: ${{ secrets.GEMINI_API_KEY != '' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Check if we have any failure context
          if [[ ! -s /tmp/failure-context.txt ]]; then
            echo "No failure context to analyze"
            exit 0
          fi
          
          # Prepare the prompt
          FAILURE_CONTEXT=$(cat /tmp/failure-context.txt | head -c 30000)  # Limit size for API
          
          PROMPT="You are analyzing E2E test failures from pipelines-as-code, a Tekton-based CI/CD system that integrates with GitHub, GitLab, Gitea, and Bitbucket.

IMPORTANT CONTEXT:
- Test names containing 'Bad', 'Invalid', 'Error', 'Wrong', 'Fail' are NEGATIVE TEST CASES - they intentionally test invalid inputs to verify error handling works correctly.
- When these tests fail, it means THE TEST ITSELF failed (e.g., timeout, infrastructure issue), NOT that there's a bug in error handling.
- Focus on WHY the test failed (look at the actual error/timeout), not what the test was testing.

The logs show the last 10 lines before each '--- FAIL: TestName' line. Log format: <job_name> <step> <timestamp> <content>

Analyze these failures and provide:

## 1. Failure Categories
Group by the ACTUAL failure reason (not what the test was testing)

## 2. Correlation Analysis
- Which tests share the same underlying failure reason?
- Are failures concentrated in specific providers (github/gitlab/gitea/bitbucket)?
- Common error messages or patterns across failures?

## 3. Priority Actions
List 2-3 specific infrastructure or test stability fixes to investigate, ranked by impact.

Be concise. Focus on the ROOT CAUSE of test failures, not what functionality the tests were verifying.

Test failure context:

$FAILURE_CONTEXT"

          # Call Gemini API
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg prompt "$PROMPT" '{contents: [{parts: [{text: $prompt}]}]}')")
          
          # Extract the text response
          ANALYSIS=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Failed to get analysis"')
          
          echo "## ðŸ¤– Gemini Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$ANALYSIS" >> $GITHUB_STEP_SUMMARY
          
          # Also print to logs
          echo "=== Gemini Analysis ==="
          echo "$ANALYSIS"